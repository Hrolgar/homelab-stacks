stages:
  - deploy

variables:
  DEPLOY_USER: "hrolgar"

.deploy_template: &deploy
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd /opt/nas/compose && git pull && cd $VM_NAME/$STACK_NAME && docker compose pull && docker compose up -d"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# ULLRINFRASTRUCTURE (10.69.1.50)
# ============================================

deploy-gitlab:
  <<: *deploy
  variables:
    DEPLOY_HOST: "10.69.1.50"
    VM_NAME: "ullrinfrastructure"
    STACK_NAME: "gitlab"

# deploy-gitlab-runner:
#   <<: *deploy
#   variables:
#     DEPLOY_HOST: "10.69.1.50"
#     VM_NAME: "ullrinfrastructure"
#     STACK_NAME: "gitlab-runner"

# ============================================
# ULLRMEDIA (add IP when ready)
# ============================================

# deploy-jellyfin:
#   <<: *deploy
#   variables:
#     DEPLOY_HOST: "10.69.1.XX"
#     VM_NAME: "ullrmedia"
#     STACK_NAME: "jellyfin"