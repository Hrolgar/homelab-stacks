stages:
  - deploy

variables:
  DEPLOY_USER: "hrolgar"

.deploy_template: &deploy
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        VM_NAME='$VM_NAME'
        STACK_NAME='$STACK_NAME'

        set -euo pipefail

        echo \"Deploying \$STACK_NAME on \$(hostname)\"

        cd /opt/nas/compose
        git fetch origin
        git reset --hard origin/main

        cd \$VM_NAME/\$STACK_NAME

        docker compose pull
        docker compose up -d

        echo \"Post-deploy status:\"
        docker compose ps
      "

  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# ULLRINFRASTRUCTURE (10.69.1.50)
# ============================================

deploy-gitlab:
  <<: *deploy
  when: manual
  allow_failure: false
  variables:
    DEPLOY_HOST: "10.69.1.50"
    VM_NAME: "ullrinfrastructure"
    STACK_NAME: "gitlab"

# ============================================
# ULLRMEDIA (add IP when ready)
# ============================================

# deploy-jellyfin:
#   <<: *deploy
#   variables:
#     DEPLOY_HOST: "10.69.1.XX"
#     VM_NAME: "ullrmedia"
#     STACK_NAME: "jellyfin"
