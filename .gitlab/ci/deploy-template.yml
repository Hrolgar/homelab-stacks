.deploy_template: &deploy
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - |
      # --- ensure target directory exists ---
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        mkdir -p /opt/compose/$VM_NAME/$STACK_NAME
      "
      # --- copy env file from CI runner ---
        if [ -n "${ENV_FILE_PATH:-}" ]; then
          scp "$ENV_FILE_PATH" \
            $DEPLOY_USER@$DEPLOY_HOST:/opt/compose/$VM_NAME/$STACK_NAME/.env
        fi

      # --- deploy on remote host ---
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        VM_NAME='$VM_NAME'
        STACK_NAME='$STACK_NAME'

        set -euo pipefail

        echo \"Deploying \$STACK_NAME on \$(hostname)\"

        sudo chown -R hrolgar:hrolgar /opt/compose

        cd /opt/compose
        git fetch origin
        git reset --hard origin/main
    
        cd $VM_NAME/$STACK_NAME
        
        docker compose pull
        docker compose up -d ${FORCE_RECREATE:-}

        echo \"Post-deploy status:\"
        docker compose ps
      "

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
